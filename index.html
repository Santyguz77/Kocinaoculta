<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="theme-color" content="#000000">
	<link rel="manifest" href="/manifest.json">
	<link rel="icon" type="image/png" href="/image.png">
	<link rel="apple-touch-icon" href="/image.png">
	<link rel="stylesheet" href="styles.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
	<title>Admin - Kocina Oculta</title>
	<style>
		/* MenÃº Hamburguesa */
		.hamburger {
			display: none;
			position: fixed;
			top: 15px;
			left: 15px;
			z-index: 1001;
			background: #ffffff;
			border: none;
			color: #000000;
			width: 50px;
			height: 50px;
			border-radius: 50%;
			font-size: 24px;
			cursor: pointer;
			box-shadow: 0 4px 12px rgba(255, 255, 255, 0.4);
			transition: transform 0.3s;
		}
		.hamburger:active {
			transform: scale(0.95);
		}
		.mobile-overlay {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.7);
			z-index: 999;
		}
		.mobile-overlay.active {
			display: block;
		}
		.sidebar.mobile-open {
			transform: translateX(0) !important;
		}
		
		@media (max-width: 768px) {
			.hamburger {
				display: flex;
				align-items: center;
				justify-content: center;
			}
			.sidebar {
				position: fixed;
				left: 0;
				top: 0;
				height: 100vh;
				transform: translateX(-100%);
				transition: transform 0.3s ease;
				z-index: 1000;
				width: 260px;
			}
			.main {
				margin-left: 0;
				padding: 80px 15px 20px 15px;
			}
		}
		
		.dashboard-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
		}
		.stat-card {
			background: linear-gradient(135deg, var(--panel), var(--card));
			padding: 25px;
			border-radius: 12px;
			box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
			border: 1px solid rgba(255, 255, 255, 0.2);
		}
		.stat-card h3 {
			font-size: 14px;
			color: var(--muted);
			text-transform: uppercase;
			margin-bottom: 10px;
		}
		.stat-card .value {
			font-size: 36px;
			font-weight: 700;
			color: var(--accent);
		}
		.section {
			display: none;
		}
		.section.active {
			display: block;
		}
		.order-card {
			background: rgba(0, 0, 0, 0.3);
			padding: 15px;
			border-radius: 8px;
			margin-bottom: 15px;
			border-left: 4px solid var(--accent);
		}
		.order-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 10px;
		}
		.order-items-list {
			margin: 10px 0;
			padding: 10px;
			background: rgba(0, 0, 0, 0.2);
			border-radius: 6px;
		}
		.order-item-line {
			display: flex;
			justify-content: space-between;
			padding: 5px 0;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
		}
		.close-cash-summary {
			background: linear-gradient(135deg, var(--success), #388e3c);
			color: #fff;
			padding: 30px;
			border-radius: 12px;
			margin-top: 20px;
		}
		.close-cash-summary h2 {
			margin-bottom: 20px;
		}
		.close-cash-line {
			display: flex;
			justify-content: space-between;
			padding: 10px 0;
			border-bottom: 1px solid rgba(255, 255, 255, 0.2);
			font-size: 18px;
		}
		.close-cash-total {
			font-size: 32px;
			font-weight: 700;
			margin-top: 20px;
			text-align: right;
		}
		
		@keyframes pulse {
			0%, 100% { opacity: 1; transform: scale(1); }
			50% { opacity: 0.5; transform: scale(1.2); }
		}
		
		@keyframes slideIn {
			from { transform: translateX(400px); opacity: 0; }
			to { transform: translateX(0); opacity: 1; }
		}
		
		@keyframes slideOut {
			from { transform: translateX(0); opacity: 1; }
			to { transform: translateX(400px); opacity: 0; }
		}
	</style>
</head>
<body>
	<script>
		// Verificar sesiÃ³n de admin
		const session = localStorage.getItem('userSession');
		if (!session) {
			window.location.href = '/login.html';
		} else {
			const userData = JSON.parse(session);
			if (userData.type !== 'admin') {
				alert('âš ï¸ Acceso denegado. Esta pÃ¡gina es solo para administradores.');
				window.location.href = '/login.html';
			}
		}
	</script>
	<!-- BotÃ³n Hamburguesa (solo mÃ³vil) -->
	<button class="hamburger" onclick="toggleMobileMenu()" aria-label="MenÃº">
		â˜°
	</button>
	
	<!-- Overlay para cerrar menÃº en mÃ³vil -->
	<div class="mobile-overlay" onclick="closeMobileMenu()"></div>
	
	<div class="app">
		<!-- Sidebar -->
		<div class="sidebar" id="sidebar">
			<div class="brand">
				<img src="image.png" alt="Logo" style="width: 60px; height: 60px; border-radius: 50%; margin-bottom: 10px;">
				<div>Kocina Oculta</div>
				<span>Panel de Control</span>
			</div>
			<ul class="menu">
				<li class="active" onclick="showSection('dashboard'); closeMobileMenu();">
					<span class="menu-icon">ğŸ“Š</span> Dashboard
				</li>
				<li onclick="showSection('tables'); closeMobileMenu();">
					<span class="menu-icon">ğŸª‘</span> Mesas
				</li>
				<li onclick="showSection('orders'); closeMobileMenu();">
					<span class="menu-icon">ğŸ“</span> Pedidos
				</li>
				<li onclick="window.open('cocina.html', '_blank'); closeMobileMenu();">
					<span class="menu-icon">ğŸ‘¨â€ğŸ³</span> Cocina
				</li>
				<li onclick="showSection('menu-config'); closeMobileMenu();">
					<span class="menu-icon">ğŸ”</span> MenÃº
				</li>
				<li onclick="showSection('transactions'); closeMobileMenu();">
					<span class="menu-icon">ğŸ’°</span> Finanzas
				</li>
				<li onclick="showSection('close-cash'); closeMobileMenu();">
					<span class="menu-icon">ğŸ”’</span> Cierre de Caja
				</li>
				<li onclick="showSection('profitability'); closeMobileMenu();">
					<span class="menu-icon">ğŸ“Š</span> Rentabilidad
				</li>
				<li onclick="showSection('system-config'); closeMobileMenu();">
					<span class="menu-icon">âš™ï¸</span> ConfiguraciÃ³n
				</li>
				<li onclick="logout()" style="margin-top: 20px; border-top: 1px solid rgba(255,107,53,0.2); padding-top: 15px;">
					<span class="menu-icon">ğŸšª</span> Cerrar SesiÃ³n
				</li>
			</ul>
		</div>

		<!-- Main Content -->
		<div class="main">
			<!-- Dashboard -->
			<div id="dashboard" class="section active">
				<div class="header">
					<h1>Dashboard</h1>
					<div style="display: flex; align-items: center; gap: 15px;">
						<button class="btn" onclick="refreshData()">ğŸ”„ Actualizar</button>
						<span style="color: #4caf50; font-size: 14px; display: flex; align-items: center; gap: 5px;">
							<span style="width: 8px; height: 8px; background: #4caf50; border-radius: 50%; animation: pulse 2s infinite;"></span>
							Auto-actualizaciÃ³n activa
						</span>
					</div>
				</div>

				<div class="dashboard-grid">
					<div class="stat-card">
						<h3>Mesas Ocupadas</h3>
						<div class="value" id="stat-tables">0</div>
					</div>
					<div class="stat-card">
						<h3>Pedidos Activos</h3>
						<div class="value" id="stat-orders">0</div>
					</div>
					<div class="stat-card">
						<h3>Ventas Hoy</h3>
						<div class="value" id="stat-sales">$0</div>
					</div>
					<div class="stat-card">
						<h3>Total Mes</h3>
						<div class="value" id="stat-month">$0</div>
					</div>
				</div>

				<div class="card">
					<h3>Mesas en Tiempo Real</h3>
					<div class="tables-grid" id="dashboard-tables"></div>
				</div>
			</div>

			<!-- Mesas -->
			<div id="tables" class="section">
				<div class="header">
					<h1>GestiÃ³n de Mesas</h1>
					<button class="btn" onclick="openTableModal()">â• Agregar Mesa</button>
				</div>
				<div class="card">
					<div class="tables-grid" id="tables-list"></div>
				</div>
			</div>

			<!-- Pedidos -->
			<div id="orders" class="section">
				<div class="header">
					<h1>Pedidos Activos</h1>
					<div class="controls">
						<button class="btn btn-success" onclick="refreshData()">ğŸ”„ Actualizar</button>
					</div>
				</div>
				<div class="card" id="orders-list"></div>
			</div>

			<!-- ConfiguraciÃ³n de MenÃº -->
			<div id="menu-config" class="section">
				<div class="header">
					<h1>ConfiguraciÃ³n del MenÃº</h1>
					<button class="btn" onclick="openMenuItemModal()">â• Nuevo Producto</button>
				</div>
				<div class="card">
					<div class="table-scroll">
						<table id="menu-table">
							<thead>
								<tr>
									<th>Nombre</th>
									<th>DescripciÃ³n</th>
									<th>CategorÃ­a</th>
									<th>Costo</th>
									<th>Precio</th>
									<th>Ganancia</th>
									<th>Margen</th>
									<th>Visible en MenÃº</th>
									<th>Acciones</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- Finanzas -->
			<div id="transactions" class="section">
				<div class="header">
					<h1>Historial de Transacciones</h1>
				</div>
				<div class="card">
					<div class="table-scroll">
						<table id="transactions-table">
							<thead>
								<tr>
									<th>Fecha</th>
									<th>Mesa</th>
									<th>Concepto</th>
									<th>Monto</th>
									<th>Acciones</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- Cierre de Caja -->
			<div id="close-cash" class="section">
				<div class="header">
					<h1>Cierre de Caja</h1>
					<div class="controls">
						<button class="btn btn-warning" onclick="generateCloseCash()">ğŸ“„ Generar Cierre Actual</button>
						<button class="btn btn-secondary" onclick="viewClosureHistory()">ğŸ“‹ Historial</button>
					</div>
				</div>
				<div class="card">
					<div id="close-cash-content">
						<p class="text-center" style="color: var(--muted); padding: 40px;">
							Haz clic en "Generar Cierre Actual" para ver el resumen del dÃ­a
						</p>
					</div>
				</div>

				<div id="closure-history" style="margin-top: 20px; display: none;">
					<h3 style="color: var(--accent); margin-bottom: 15px;">Historial de Cierres</h3>
					<div class="table-scroll">
						<table id="closures-table">
							<thead>
								<tr>
									<th>Fecha</th>
									<th>Transacciones</th>
									<th>Total</th>
									<th>Acciones</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- Rentabilidad -->
			<div id="profitability" class="section">
				<div class="header">
					<h1>ğŸ“Š AnÃ¡lisis de Rentabilidad</h1>
					<div class="controls">
						<button class="btn" onclick="generateProfitabilityReport()">ğŸ“„ Actualizar Datos</button>
						<button class="btn btn-secondary" onclick="showDebugInfo()">ğŸ” Info Sistema</button>
					</div>
				</div>

				<div id="cost-warning" style="background: rgba(255, 152, 0, 0.1); border: 2px solid #ff9800; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
					<div style="display: flex; align-items: center; gap: 10px;">
						<span style="font-size: 24px;">âš ï¸</span>
						<div>
							<strong style="color: #ff9800;">Algunos productos no tienen costo configurado</strong>
							<p style="color: var(--muted); margin: 5px 0 0 0; font-size: 14px;">
								Para obtener datos precisos de rentabilidad, edita tus productos en la secciÃ³n <strong>MenÃº</strong> y agrega el costo de producciÃ³n de cada uno.
							</p>
						</div>
					</div>
				</div>
				
				<!-- MÃ©tricas Principales -->
				<div class="dashboard-grid" style="margin-bottom: 30px;">
					<div class="stat-card">
						<h3>ğŸ’° Ganancia Hoy</h3>
						<div class="value" id="profit-today">$0</div>
						<small style="color: var(--muted); font-size: 13px;" id="profit-today-change">-</small>
					</div>
					<div class="stat-card">
						<h3>ğŸ“ˆ Ganancia Mes</h3>
						<div class="value" id="profit-month">$0</div>
						<small style="color: var(--muted); font-size: 13px;" id="orders-month-count">-</small>
					</div>
					<div class="stat-card">
						<h3>ğŸ¯ Margen Promedio</h3>
						<div class="value" id="margin-avg">0%</div>
						<small style="color: var(--muted); font-size: 13px;">Eficiencia operativa</small>
					</div>
					<div class="stat-card">
						<h3>ğŸ† Producto Top</h3>
						<div class="value" id="most-profitable" style="font-size: 18px;">-</div>
						<small style="color: var(--muted); font-size: 13px;" id="most-profitable-profit">-</small>
					</div>
					<div class="stat-card">
						<h3>ğŸ”¥ MÃ¡s Vendido</h3>
						<div class="value" id="most-sold" style="font-size: 18px;">-</div>
						<small style="color: var(--muted); font-size: 13px;" id="most-sold-quantity">-</small>
					</div>
					<div class="stat-card">
						<h3>ğŸ’µ Ticket Promedio</h3>
						<div class="value" id="avg-ticket">$0</div>
						<small style="color: var(--muted); font-size: 13px;" id="total-tickets">-</small>
					</div>
				</div>

				<!-- GrÃ¡ficas -->
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; margin-bottom: 30px;">
					<!-- Ventas por DÃ­a (Ãšltimos 7 dÃ­as) -->
					<div class="card">
						<h3 style="margin-bottom: 20px;">ğŸ“… Ventas por DÃ­a (Ãšltimos 7 dÃ­as)</h3>
						<canvas id="sales-by-day-chart" style="max-height: 300px;"></canvas>
					</div>

					<!-- Top 5 Productos MÃ¡s Vendidos -->
					<div class="card">
						<h3 style="margin-bottom: 20px;">ğŸ† Top 5 Productos MÃ¡s Vendidos</h3>
						<canvas id="top-products-chart" style="max-height: 300px;"></canvas>
					</div>
				</div>

				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; margin-bottom: 30px;">
					<!-- Ganancias por Mes -->
					<div class="card">
						<h3 style="margin-bottom: 20px;">ğŸ“Š Ganancias Mensuales</h3>
						<canvas id="profit-by-month-chart" style="max-height: 300px;"></canvas>
					</div>

					<!-- DistribuciÃ³n de Ventas por CategorÃ­a -->
					<div class="card">
						<h3 style="margin-bottom: 20px;">ğŸ• Ventas por CategorÃ­a</h3>
						<canvas id="category-chart" style="max-height: 300px;"></canvas>
					</div>
				</div>

				<!-- Tabla Detallada de Rentabilidad -->
				<div class="card">
					<h3 style="margin-bottom: 20px;">ğŸ“‹ Rentabilidad Detallada por Producto</h3>
					<div class="table-scroll">
						<table id="profitability-table">
							<thead>
								<tr>
									<th>Producto</th>
									<th>Unidades Vendidas</th>
									<th>Costo Total</th>
									<th>Ventas Totales</th>
									<th>Ganancia Total</th>
									<th>Margen</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- ConfiguraciÃ³n del Sistema -->
			<div id="system-config" class="section">
				<div class="header">
					<h1>ConfiguraciÃ³n del Sistema</h1>
				</div>

				<div class="card" style="margin-bottom: 20px;">
					<h3 style="color: #ff4444; margin-bottom: 15px;">âš ï¸ Zona de Peligro</h3>
					<p style="color: var(--muted); margin-bottom: 20px;">
						Estas acciones son <strong>irreversibles</strong>. Ãšsalas con precauciÃ³n.
					</p>
					
					<div style="background: rgba(255, 68, 68, 0.1); border: 2px solid #ff4444; padding: 20px; border-radius: 8px;">
						<h4 style="color: #ff4444; margin-bottom: 10px;">ğŸ—‘ï¸ Limpiar Datos de Ventas</h4>
						<p style="color: var(--muted); margin-bottom: 15px; font-size: 14px;">
							Elimina todas las Ã³rdenes, transacciones y cierres de caja. <strong>NO elimina</strong> productos del menÃº ni meseros.
							Ãštil para entregar la aplicaciÃ³n como nueva o resetear datos de prueba.
						</p>
						<ul style="color: var(--muted); margin: 15px 0; padding-left: 25px; font-size: 14px;">
							<li>âœ“ Se eliminarÃ¡n todas las Ã³rdenes (completadas, pendientes, canceladas)</li>
							<li>âœ“ Se eliminarÃ¡n todas las transacciones</li>
							<li>âœ“ Se eliminarÃ¡n todos los cierres de caja</li>
							<li>âœ“ Las mesas volverÃ¡n a estado "Disponible"</li>
							<li>âœ— Los productos del menÃº se mantendrÃ¡n</li>
							<li>âœ— Los meseros se mantendrÃ¡n</li>
						</ul>
						<button class="btn" style="background: #ff4444; border: none;" onclick="resetSalesData()">
							ğŸ—‘ï¸ Limpiar Todos los Datos de Ventas
						</button>
					</div>
				</div>

				<div class="card">
					<h3 style="margin-bottom: 15px;">â„¹ï¸ InformaciÃ³n del Sistema</h3>
					<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
						<div style="background: var(--panel); padding: 15px; border-radius: 8px;">
							<div style="color: var(--muted); font-size: 13px;">Productos en MenÃº</div>
							<div style="color: var(--accent); font-size: 24px; font-weight: 700;" id="info-menu-items">0</div>
						</div>
						<div style="background: var(--panel); padding: 15px; border-radius: 8px;">
							<div style="color: var(--muted); font-size: 13px;">Mesas Configuradas</div>
							<div style="color: var(--accent); font-size: 24px; font-weight: 700;" id="info-tables">0</div>
						</div>
						<div style="background: var(--panel); padding: 15px; border-radius: 8px;">
							<div style="color: var(--muted); font-size: 13px;">Ã“rdenes Totales</div>
							<div style="color: var(--accent); font-size: 24px; font-weight: 700;" id="info-orders">0</div>
						</div>
						<div style="background: var(--panel); padding: 15px; border-radius: 8px;">
							<div style="color: var(--muted); font-size: 13px;">Meseros Registrados</div>
							<div style="color: var(--accent); font-size: 24px; font-weight: 700;" id="info-waiters">0</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal Mesa -->
	<div id="table-modal" class="modal">
		<div class="panel">
			<div class="modal-header">
				<h3 id="table-modal-title">Nueva Mesa</h3>
				<button class="modal-close" onclick="closeTableModal()">âœ•</button>
			</div>
			<div class="form-row">
				<div class="form-group" style="flex: 1;">
					<label>NÃºmero de Mesa</label>
					<input type="number" id="table-number" placeholder="1">
				</div>
				<div class="form-group" style="flex: 1;">
					<label>Capacidad</label>
					<input type="number" id="table-capacity" placeholder="4">
				</div>
			</div>
			<div class="controls">
				<button class="btn" onclick="saveTable()">ğŸ’¾ Guardar</button>
				<button class="btn btn-secondary" onclick="closeTableModal()">Cancelar</button>
			</div>
		</div>
	</div>

	<!-- Modal Producto MenÃº -->
	<div id="menu-item-modal" class="modal">
		<div class="panel">
			<div class="modal-header">
				<h3 id="menu-item-modal-title">Nuevo Producto</h3>
				<button class="modal-close" onclick="closeMenuItemModal()">âœ•</button>
			</div>
			<div class="form-group">
				<label>Nombre</label>
				<input type="text" id="item-name" placeholder="Ej: Hamburguesa ClÃ¡sica">
			</div>
			<div class="form-group">
				<label>DescripciÃ³n</label>
				<textarea id="item-description" placeholder="DescripciÃ³n del producto"></textarea>
			</div>
			<div class="form-group">
				<label>CategorÃ­a</label>
				<input type="text" id="item-category" placeholder="Ej: Hamburguesas">
			</div>
			<div class="form-row">
				<div class="form-group" style="flex: 1;">
					<label>Costo de ProducciÃ³n</label>
					<input type="number" id="item-cost" placeholder="0.00" step="0.01" oninput="updateProfitPreview()">
					<small style="color: var(--muted); display: block; margin-top: 4px;">Â¿CuÃ¡nto te cuesta producirlo?</small>
				</div>
				<div class="form-group" style="flex: 1;">
					<label>Precio de Venta</label>
					<input type="number" id="item-price" placeholder="0.00" step="0.01" oninput="updateProfitPreview()">
					<small style="color: var(--muted); display: block; margin-top: 4px;">Â¿A cuÃ¡nto lo vendes?</small>
				</div>
			</div>
			<div id="profit-preview" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none;">
				<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
					<span>Ganancia por unidad:</span>
					<strong id="profit-amount" style="color: var(--accent);">$0.00</strong>
				</div>
				<div style="display: flex; justify-content: space-between;">
					<span>Margen de ganancia:</span>
					<strong id="profit-margin" style="color: var(--accent);">0%</strong>
				</div>
			</div>
			<div class="form-group">
				<label>Imagen del Producto</label>
				<input type="file" id="item-image-file" accept="image/*" onchange="handleImageUpload(this)" style="width: 100%;">
				<small style="color: var(--muted); display: block; margin-top: 4px;">Sube una imagen desde tu dispositivo</small>
				<div id="item-image-preview" style="margin-top: 10px;"></div>
				<input type="hidden" id="item-image">
			</div>
			<div class="form-group">
				<label>
					<input type="checkbox" id="item-available" checked> Disponible
				</label>
			</div>
			<div class="controls">
				<button class="btn" onclick="saveMenuItem()">ğŸ’¾ Guardar</button>
				<button class="btn btn-secondary" onclick="closeMenuItemModal()">Cancelar</button>
			</div>
		</div>
	</div>

	<!-- Modal Detalle de Mesa -->
	<div id="table-detail-modal" class="modal">
		<div class="panel">
			<div class="modal-header">
				<h3 id="table-detail-title">Detalle Mesa</h3>
				<button class="modal-close" onclick="closeTableDetailModal()">âœ•</button>
			</div>
			<div id="table-detail-content"></div>
		</div>
	</div>

	<!-- Modal Tomar Pedido -->
	<div id="order-modal" class="modal">
		<div class="panel" style="max-width: 1200px;">
			<div class="modal-header">
				<h3 id="order-modal-title">Nuevo Pedido</h3>
				<button class="modal-close" onclick="closeOrderModal()">âœ•</button>
			</div>
			
			<div style="display: grid; grid-template-columns: 1fr 400px; gap: 20px;">
				<!-- MenÃº de productos -->
				<div style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
					<h4 style="color: var(--accent); margin-bottom: 15px;">ğŸ” Seleccionar Productos</h4>
					<div id="order-menu-items"></div>
				</div>
				
				<!-- Resumen del pedido -->
				<div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.1);">
					<h4 style="color: var(--accent); margin-bottom: 15px;">ğŸ“ Pedido Actual</h4>
					<div id="order-items-summary" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;"></div>
					
					<div style="background: linear-gradient(135deg, #ffffff, #e0e0e0); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
						<div style="font-size: 14px; color: #000000; margin-bottom: 5px; font-weight: 600;">Total a Pagar</div>
						<div id="order-total-amount" style="font-size: 32px; font-weight: 700; color: #000000;">$0.00</div>
					</div>
					
					<div style="display: flex; flex-direction: column; gap: 10px;">
						<button class="btn" onclick="saveOrderFromModal()" style="width: 100%;">ğŸ’¾ Guardar Pedido</button>
						<button class="btn btn-secondary" onclick="closeOrderModal()" style="width: 100%;">Cancelar</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src="app.js"></script>
	<script>
		let currentEditingTable = null;
		let currentEditingMenuItem = null;
		let autoRefreshInterval = null;
		let isRefreshing = false;

		async function init() {
			await loadInitialData();
			await initializeDefaultData();
			renderDashboard();
			renderAllSections();
			startAutoRefresh();
		}
		
		// Auto-actualizaciÃ³n cada 5 segundos
		function startAutoRefresh() {
			// Limpiar intervalo anterior si existe
			if (autoRefreshInterval) {
				clearInterval(autoRefreshInterval);
			}
			
			// Actualizar cada 5 segundos
			autoRefreshInterval = setInterval(async () => {
				if (!isRefreshing) {
					isRefreshing = true;
					try {
						await loadInitialData();
						
						// Solo actualizar la secciÃ³n activa para no interrumpir formularios
						const activeSection = document.querySelector('.section.active');
						if (activeSection) {
							const sectionId = activeSection.id;
							if (sectionId === 'dashboard') renderDashboard();
							if (sectionId === 'tables') renderTables();
							if (sectionId === 'orders') renderOrders();
							if (sectionId === 'transactions') renderTransactions();
						}
						
						// Actualizar badge de notificaciones si hay pedidos nuevos
						updateNotificationBadge();
					} catch (error) {
						console.error('Error en auto-refresh:', error);
					} finally {
						isRefreshing = false;
					}
				}
			}, 5000); // 5 segundos
		}
		
		function stopAutoRefresh() {
			if (autoRefreshInterval) {
				clearInterval(autoRefreshInterval);
				autoRefreshInterval = null;
			}
		}
		
		function updateNotificationBadge() {
			const activeOrders = AppState.orders.filter(o => o.status === 'pending').length;
			// AquÃ­ podrÃ­as agregar un badge visual si quieres
			if (activeOrders > 0) {
				document.title = `(${activeOrders}) Admin - Sistema Restaurante`;
			} else {
				document.title = 'Admin - Sistema Restaurante';
			}
		}

		// SISTEMA DE NOTIFICACIONES DE COCINA
		// Para mismo dispositivo (mismo localStorage)
		window.addEventListener('storage', (e) => {
			if (e.key === 'kitchenNotification' && e.newValue) {
				const notification = JSON.parse(e.newValue);
				showKitchenReadyNotification(notification);
				// Limpiar la notificaciÃ³n
				localStorage.removeItem('kitchenNotification');
			}
		});

		// Para diferentes dispositivos (polling de pedidos listos)
		let lastNotifiedOrders = new Set();
		setInterval(async () => {
			// Verificar pedidos que estÃ¡n completamente listos y no han sido notificados
			const ordersToNotify = AppState.orders.filter(order => {
				return order.status === 'pending' && 
				       order.items.length > 0 &&
				       order.items.every(item => item.kitchenStatus === 'ready') &&
				       order.kitchenNotifiedAt && 
				       !lastNotifiedOrders.has(order.id);
			});

			for (const order of ordersToNotify) {
				// Verificar que la notificaciÃ³n es reciente (Ãºltimos 10 segundos)
				const notifiedTime = new Date(order.kitchenNotifiedAt).getTime();
				const now = Date.now();
				if (now - notifiedTime < 10000) {
					lastNotifiedOrders.add(order.id);
					showKitchenReadyNotification({
						tableNumber: order.tableNumber,
						orderId: order.id,
						timestamp: order.kitchenNotifiedAt
					});
				}
			}

			// Limpiar pedidos antiguos del set
			if (lastNotifiedOrders.size > 50) {
				lastNotifiedOrders.clear();
			}
		}, 2000); // Verificar cada 2 segundos

		function showKitchenReadyNotification(notification) {
			// Reproducir sonido de notificaciÃ³n
			playKitchenNotificationSound();

			// Mostrar notificaciÃ³n visual
			const notifDiv = document.createElement('div');
			notifDiv.style.cssText = `
				position: fixed;
				top: 80px;
				right: 30px;
				background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
				color: #fff;
				padding: 20px 30px;
				border-radius: 12px;
				box-shadow: 0 8px 30px rgba(76, 175, 80, 0.5);
				z-index: 10000;
				font-size: 16px;
				font-weight: 600;
				animation: slideInRight 0.5s ease;
				min-width: 300px;
			`;
			
			notifDiv.innerHTML = `
				<div style="display: flex; align-items: center; gap: 15px;">
					<span style="font-size: 40px;">âœ…</span>
					<div>
						<div style="font-size: 18px; margin-bottom: 5px;">Â¡Pedido Listo!</div>
						<div style="font-size: 14px; opacity: 0.9;">Mesa ${notification.tableNumber}</div>
					</div>
				</div>
			`;

			document.body.appendChild(notifDiv);

			// Animar y remover despuÃ©s de 5 segundos
			setTimeout(() => {
				notifDiv.style.animation = 'slideOutRight 0.5s ease';
				setTimeout(() => notifDiv.remove(), 500);
			}, 5000);

			// Actualizar datos para reflejar el estado
			loadInitialData().then(() => {
				renderAllSections();
			});
		}

		function playKitchenNotificationSound() {
			try {
				const audioContext = new (window.AudioContext || window.webkitAudioContext)();
				
				// Primer beep
				const playBeep = (frequency, startTime, duration) => {
					const oscillator = audioContext.createOscillator();
					const gainNode = audioContext.createGain();
					
					oscillator.connect(gainNode);
					gainNode.connect(audioContext.destination);
					
					oscillator.frequency.value = frequency;
					oscillator.type = 'sine';
					gainNode.gain.value = 0.3;
					
					oscillator.start(startTime);
					oscillator.stop(startTime + duration);
				};

				// Triple beep melodioso
				const now = audioContext.currentTime;
				playBeep(600, now, 0.15);
				playBeep(800, now + 0.2, 0.15);
				playBeep(1000, now + 0.4, 0.3);
			} catch (error) {
				console.log('No se pudo reproducir sonido');
			}
		}

		// Agregar estilos de animaciÃ³n
		const style = document.createElement('style');
		style.textContent = `
			@keyframes slideInRight {
				from {
					transform: translateX(400px);
					opacity: 0;
				}
				to {
					transform: translateX(0);
					opacity: 1;
				}
			}
			@keyframes slideOutRight {
				from {
					transform: translateX(0);
					opacity: 1;
				}
				to {
					transform: translateX(400px);
					opacity: 0;
				}
			}
		`;
		document.head.appendChild(style);

		function showSection(sectionId) {
			document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
			document.getElementById(sectionId).classList.add('active');
			document.querySelectorAll('.menu li').forEach(li => li.classList.remove('active'));
			event.target.closest('li').classList.add('active');
			
			// Pausar auto-refresh al editar menÃº para no interrumpir
			if (sectionId === 'menu-config') {
				stopAutoRefresh();
			} else {
				startAutoRefresh();
			}
			
			if (sectionId === 'dashboard') renderDashboard();
			if (sectionId === 'tables') renderTables();
			if (sectionId === 'orders') renderOrders();
			if (sectionId === 'menu-config') renderMenuConfig();
			if (sectionId === 'transactions') renderTransactions();
			if (sectionId === 'profitability') renderProfitability();
			if (sectionId === 'system-config') updateSystemInfo();
		}

		async function refreshData() {
			const btn = event.target;
			btn.disabled = true;
			btn.textContent = 'â³ Actualizando...';
			
			await loadInitialData();
			renderAllSections();
			
			btn.disabled = false;
			btn.innerHTML = 'ğŸ”„ Actualizar';
			
			// Mostrar notificaciÃ³n temporal
			const notification = document.createElement('div');
			notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ffffff; color: #000000; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(255,255,255,0.3); z-index: 9999; animation: slideIn 0.3s ease;';
			notification.textContent = 'âœ… Datos actualizados';
			document.body.appendChild(notification);
			
			setTimeout(() => {
				notification.style.animation = 'slideOut 0.3s ease';
				setTimeout(() => notification.remove(), 300);
			}, 2000);
		}

		function renderAllSections() {
			renderDashboard();
			renderTables();
			renderOrders();
			renderMenuConfig();
			renderTransactions();
		}

		// DASHBOARD
		function renderDashboard() {
			const occupiedTables = AppState.tables.filter(t => t.status === 'occupied').length;
			const activeOrders = AppState.orders.filter(o => o.status === 'pending').length;
			
			// Calcular ventas basÃ¡ndose en Ã³rdenes completadas (igual que rentabilidad)
			const today = new Date().toISOString().split('T')[0];
			const thisMonth = new Date().toISOString().slice(0, 7);
			
			let todaySales = 0;
			let monthSales = 0;
			
			AppState.orders.filter(o => o.status === 'completed').forEach(order => {
				const orderDate = order.completedAt ? order.completedAt.split('T')[0] : '';
				const orderMonth = order.completedAt ? order.completedAt.slice(0, 7) : '';
				
				let orderTotal = 0;
				order.items.forEach(item => {
					orderTotal += item.price * item.quantity;
				});
				
				if (orderDate === today) todaySales += orderTotal;
				if (orderMonth === thisMonth) monthSales += orderTotal;
			});

			document.getElementById('stat-tables').textContent = occupiedTables;
			document.getElementById('stat-orders').textContent = activeOrders;
			document.getElementById('stat-sales').textContent = Utils.formatCurrency(todaySales);
			document.getElementById('stat-month').textContent = Utils.formatCurrency(monthSales);

			const container = document.getElementById('dashboard-tables');
			container.innerHTML = AppState.tables.map(table => {
				const order = table.currentOrder ? AppState.orders.find(o => o.id === table.currentOrder) : null;
				return `
					<div class="table-card ${table.status}">
						<div class="table-number">Mesa ${table.number}</div>
						<div class="table-status">
							${table.status === 'available' ? 'âœ… Disponible' : 
							  table.status === 'occupied' ? 'ğŸ”´ Ocupada' : 'ğŸ“ Reservada'}
						</div>
						${order ? `<div class="badge badge-warning" style="margin-top: 8px; font-size: 11px;">
							${order.items.length} productos | ${Utils.formatCurrency(order.total)}
						</div>` : ''}
						<div style="margin-top: 12px; display: flex; gap: 5px; flex-direction: column;">
							${table.status === 'available' ? 
								`<button class="btn btn-small" onclick="event.stopPropagation(); openOrderModal('${table.id}')" style="width: 100%;">ğŸ“ Tomar Pedido</button>` : ''}
							${table.status === 'occupied' ? 
								`<button class="btn btn-small btn-warning" onclick="event.stopPropagation(); viewTableDetails('${table.id}')" style="width: 100%;">ğŸ‘ï¸ Ver Pedido</button>
								<button class="btn btn-small" onclick="event.stopPropagation(); openOrderModal('${table.id}')" style="width: 100%;">â• AÃ±adir Items</button>` : ''}
						</div>
					</div>
				`;
			}).join('');
		}

		// MESAS
		function renderTables() {
			const container = document.getElementById('tables-list');
			container.innerHTML = AppState.tables.map(table => {
				const order = table.currentOrder ? AppState.orders.find(o => o.id === table.currentOrder) : null;
				const isTakeaway = table.isTakeaway || (order && order.isTakeaway);
				return `
					<div class="table-card ${table.status}" style="${isTakeaway ? 'border-left: 4px solid #ff9800;' : ''}">
						<div class="table-number">
							${isTakeaway ? 'ğŸ›ï¸ ' : ''}${table.number}
							${isTakeaway ? '<span style="display: block; font-size: 12px; color: #ff9800; margin-top: 4px;">Para Llevar</span>' : ''}
						</div>
						${!isTakeaway ? `<div class="table-status">Capacidad: ${table.capacity} personas</div>` : ''}
						<div class="table-status">
							${table.status === 'available' ? 'âœ… Disponible' : 
							  table.status === 'occupied' ? 'ğŸ”´ Ocupada' : 'ğŸ“ Reservada'}
						</div>
						${order ? `<div class="badge badge-info" style="margin-top: 8px; font-size: 11px;">
							${order.items.length} productos | ${Utils.formatCurrency(order.total)}
						</div>` : ''}
						<div style="margin-top: 10px; display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
							${table.status === 'occupied' ? 
								`<button class="btn btn-small btn-warning" onclick="viewTableDetails('${table.id}')">ğŸ‘ï¸ Ver</button>` : ''}
							${!isTakeaway ? `<button class="btn btn-small btn-secondary" onclick="editTable('${table.id}')">âœï¸</button>` : ''}
							${!isTakeaway ? `<button class="btn btn-small btn-danger" onclick="deleteTable('${table.id}')">ğŸ—‘ï¸</button>` : ''}
							${table.status === 'occupied' ? 
								`<button class="btn btn-small btn-success" onclick="freeTable('${table.id}')">âœ“ Liberar</button>` : ''}
						</div>
					</div>
				`;
			}).join('');
		}

		function openTableModal(tableId = null) {
			if (tableId) {
				currentEditingTable = AppState.tables.find(t => t.id === tableId);
				document.getElementById('table-modal-title').textContent = 'Editar Mesa';
				document.getElementById('table-number').value = currentEditingTable.number;
				document.getElementById('table-capacity').value = currentEditingTable.capacity;
			} else {
				currentEditingTable = null;
				document.getElementById('table-modal-title').textContent = 'Nueva Mesa';
				document.getElementById('table-number').value = '';
				document.getElementById('table-capacity').value = '4';
			}
			document.getElementById('table-modal').classList.add('show');
		}

		function closeTableModal() {
			document.getElementById('table-modal').classList.remove('show');
			currentEditingTable = null;
		}

		function editTable(tableId) {
			openTableModal(tableId);
		}

		async function saveTable() {
			const number = parseInt(document.getElementById('table-number').value);
			const capacity = parseInt(document.getElementById('table-capacity').value);

			if (!number || !capacity) {
				Utils.showNotification('Completa todos los campos', 'warning');
				return;
			}

			if (currentEditingTable) {
				currentEditingTable.number = number;
				currentEditingTable.capacity = capacity;
				const index = AppState.tables.findIndex(t => t.id === currentEditingTable.id);
				AppState.tables[index] = currentEditingTable;
			} else {
				AppState.tables.push({
					id: Utils.generateId(),
					number,
					capacity,
					status: 'available',
					currentOrder: null
				});
			}

			await API.save('tables', AppState.tables);
			closeTableModal();
			renderTables();
			renderDashboard();
			Utils.showNotification('Mesa guardada', 'success');
		}

		async function deleteTable(tableId) {
			if (!confirm('Â¿Eliminar esta mesa?')) return;
			AppState.tables = AppState.tables.filter(t => t.id !== tableId);
			await API.save('tables', AppState.tables);
			renderTables();
			renderDashboard();
			Utils.showNotification('Mesa eliminada', 'success');
		}

		async function freeTable(tableId) {
			if (!confirm('Â¿Liberar esta mesa?')) return;
			const table = AppState.tables.find(t => t.id === tableId);
			if (table) {
				table.status = 'available';
				table.currentOrder = null;
				await API.save('tables', AppState.tables);
				renderTables();
				renderDashboard();
				Utils.showNotification('Mesa liberada', 'success');
			}
		}

		// PEDIDOS
		function renderOrders() {
			const container = document.getElementById('orders-list');
			const activeOrders = AppState.orders.filter(o => o.status === 'pending');
			
			if (activeOrders.length === 0) {
				container.innerHTML = '<p class="text-center" style="color: var(--muted); padding: 40px;">No hay pedidos activos</p>';
				return;
			}

			container.innerHTML = activeOrders.map(order => `
				<div class="order-card">
					<div class="order-header">
						<div>
							<strong style="color: var(--accent);">Mesa ${order.tableNumber}</strong>
							<div class="small">${Utils.formatDate(order.createdAt)}</div>
						</div>
						<div>
							<span class="badge badge-warning">Pendiente</span>
						</div>
					</div>
					<div class="order-items-list">
						${order.items.map(item => `
							<div class="order-item-line">
								<div>${item.quantity}x ${item.name} ${item.notes ? `<br><small style="color: var(--muted);">Nota: ${item.notes}</small>` : ''}</div>
								<div>${Utils.formatCurrency(item.price * item.quantity)}</div>
							</div>
						`).join('')}
					</div>
					<div style="text-align: right; font-size: 20px; font-weight: 700; color: var(--success); margin-top: 10px;">
						Total: ${Utils.formatCurrency(order.total)}
					</div>
					<div style="margin-top: 15px; display: flex; gap: 10px;">
						<button class="btn btn-success" onclick="completeOrder('${order.id}')">âœ“ Completar y Facturar</button>
						<button class="btn btn-danger" onclick="cancelOrder('${order.id}')">âœ• Cancelar</button>
					</div>
				</div>
			`).join('');
		}

		let isCompletingOrder = false;

		async function completeOrder(orderId) {
			if (isCompletingOrder) {
				Utils.showNotification('OperaciÃ³n en proceso, por favor espera...', 'warning');
				return;
			}
			
			const order = AppState.orders.find(o => o.id === orderId);
			if (!order) {
				Utils.showNotification('Pedido no encontrado', 'error');
				return;
			}

			// Confirmar con el usuario
			if (!confirm(`Â¿Completar pedido de Mesa ${order.tableNumber}?\nTotal: ${Utils.formatCurrency(order.total)}`)) {
				return;
			}

			isCompletingOrder = true;
			Utils.showNotification('Procesando pedido...', 'info');

			try {
				// Pausar auto-refresh durante la operaciÃ³n
				if (autoRefreshInterval) {
					clearInterval(autoRefreshInterval);
				}

				// 1. Actualizar orden
				order.status = 'completed';
				order.completedAt = new Date().toISOString();

				// 2. Crear transacciÃ³n
				const transaction = {
					id: Utils.generateId(),
					orderId: order.id,
					tableNumber: order.tableNumber,
					amount: order.total,
					type: 'sale',
					date: new Date().toISOString(),
					concept: `Mesa ${order.tableNumber} - ${order.items.length} productos`
				};
				AppState.transactions.push(transaction);

				// 3. Liberar mesa
				const table = AppState.tables.find(t => t.id === order.tableId);
				if (table) {
					if (table.isTakeaway || order.isTakeaway) {
						AppState.tables = AppState.tables.filter(t => t.id !== table.id);
					} else {
						table.status = 'available';
						table.currentOrder = null;
					}
				}

				// 4. GUARDAR TODO EN SERVIDOR (ESPERAR CONFIRMACIÃ“N)
				await Promise.all([
					API.save('orders', AppState.orders),
					API.save('transactions', AppState.transactions),
					API.save('tables', AppState.tables)
				]);

				// 5. Generar PDF despuÃ©s de confirmar guardado
				await generateInvoicePDF(order);

				// 6. RECARGAR DATOS DESDE SERVIDOR para garantizar sincronizaciÃ³n
				await loadInitialData();

				// 7. Actualizar UI con datos frescos del servidor
				renderOrders();
				renderDashboard();
				renderTables();
				renderTransactions();
				generateProfitabilityReport();

				Utils.showNotification('Pedido completado exitosamente', 'success');

			} catch (error) {
				console.error('Error completando orden:', error);
				
				// REVERTIR CAMBIOS recargando desde servidor
				await loadInitialData();
				renderOrders();
				renderDashboard();
				renderTables();
				renderTransactions();
				
				Utils.showNotification('Error al completar pedido. Verifica la conexiÃ³n al servidor.', 'error');
				alert('âŒ Error al completar el pedido:\n\n' + error.message + '\n\nLos cambios no se guardaron. Verifica tu conexiÃ³n e intenta nuevamente.');
				
			} finally {
				isCompletingOrder = false;
				// Reiniciar auto-refresh
				startAutoRefresh();
			}
		}

	let isCancellingOrder = false;

	async function cancelOrder(orderId) {
		if (isCancellingOrder) {
			Utils.showNotification('OperaciÃ³n en proceso, por favor espera...', 'warning');
			return;
		}
		
		if (!confirm('Â¿EstÃ¡s seguro de cancelar este pedido?')) return;

		isCancellingOrder = true;
		Utils.showNotification('Cancelando pedido...', 'info');

		try {
			// Pausar auto-refresh
			if (autoRefreshInterval) {
				clearInterval(autoRefreshInterval);
			}

			const order = AppState.orders.find(o => o.id === orderId);
			if (!order) {
				throw new Error('Pedido no encontrado');
			}

			order.status = 'cancelled';
			
			const table = AppState.tables.find(t => t.id === order.tableId);
			if (table) {
				table.status = 'available';
				table.currentOrder = null;
			}

			// GUARDAR EN SERVIDOR Y ESPERAR CONFIRMACIÃ“N
			await Promise.all([
				API.save('orders', AppState.orders),
				API.save('tables', AppState.tables)
			]);

			// RECARGAR desde servidor
			await loadInitialData();

			// Actualizar UI
			renderOrders();
			renderDashboard();
			renderTables();

			Utils.showNotification('Pedido cancelado exitosamente', 'success');

		} catch (error) {
			console.error('Error cancelando orden:', error);
			
			// REVERTIR recargando desde servidor
			await loadInitialData();
			renderOrders();
			renderDashboard();
			renderTables();
			
			Utils.showNotification('Error al cancelar pedido', 'error');
			alert('âŒ Error al cancelar el pedido: ' + error.message);
			
		} finally {
			isCancellingOrder = false;
			startAutoRefresh();
		}
	}		// MENÃš CONFIG
		function renderMenuConfig() {
			const tbody = document.querySelector('#menu-table tbody');
			tbody.innerHTML = AppState.menuItems.map(item => {
				const cost = item.cost || 0;
				const profit = item.price - cost;
				const margin = item.price > 0 ? ((profit / item.price) * 100).toFixed(1) : 0;
				return `
					<tr>
						<td>
							<div style="display: flex; align-items: center; gap: 10px;">
								${item.image ? `<img src="${item.image}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;">` : ''}
								<strong>${item.name}</strong>
							</div>
						</td>
						<td style="max-width: 200px; color: var(--muted); font-size: 13px;">${item.description || '-'}</td>
						<td><span class="badge badge-info">${item.category}</span></td>
						<td>${Utils.formatCurrency(cost)}</td>
						<td><strong>${Utils.formatCurrency(item.price)}</strong></td>
						<td style="color: ${profit > 0 ? 'var(--accent)' : '#999'}; font-weight: 600;">${Utils.formatCurrency(profit)}</td>
						<td>
							<span class="badge" style="background: ${margin > 50 ? '#4caf50' : margin > 30 ? '#ff9800' : '#999'}; color: #fff; font-weight: 600;">
								${margin}%
							</span>
						</td>
						<td>
							<button 
								class="btn btn-small" 
								onclick="toggleProductAvailability('${item.id}')" 
								style="background: ${item.available ? '#4caf50' : '#666'}; color: #fff; border: none; padding: 6px 14px; font-size: 12px; min-width: 90px;"
								title="${item.available ? 'Click para ocultar del menÃº' : 'Click para mostrar en el menÃº'}">
								${item.available ? 'ğŸ‘ï¸ Visible' : 'ğŸš« Oculto'}
							</button>
						</td>
						<td>
							<button class="btn btn-small btn-secondary" onclick="editMenuItem('${item.id}')" title="Editar producto">âœï¸</button>
							<button class="btn btn-small btn-danger" onclick="deleteMenuItem('${item.id}')" title="Eliminar producto">ğŸ—‘ï¸</button>
						</td>
					</tr>
				`;
			}).join('');
		}

		function openMenuItemModal(itemId = null) {
			if (itemId) {
				currentEditingMenuItem = AppState.menuItems.find(i => i.id === itemId);
				document.getElementById('menu-item-modal-title').textContent = 'Editar Producto';
				document.getElementById('item-name').value = currentEditingMenuItem.name;
				document.getElementById('item-description').value = currentEditingMenuItem.description || '';
				document.getElementById('item-category').value = currentEditingMenuItem.category;
				document.getElementById('item-cost').value = currentEditingMenuItem.cost || 0;
				document.getElementById('item-price').value = currentEditingMenuItem.price;
				document.getElementById('item-available').checked = currentEditingMenuItem.available;
				document.getElementById('item-image').value = currentEditingMenuItem.image || '';
				if (currentEditingMenuItem.image) {
					showImagePreview(currentEditingMenuItem.image);
				} else {
					clearImagePreview();
				}
				updateProfitPreview();
			} else {
				currentEditingMenuItem = null;
				document.getElementById('menu-item-modal-title').textContent = 'Nuevo Producto';
				document.getElementById('item-name').value = '';
				document.getElementById('item-description').value = '';
				document.getElementById('item-category').value = '';
				document.getElementById('item-cost').value = '0';
				document.getElementById('item-price').value = '';
				document.getElementById('item-available').checked = true;
				document.getElementById('item-image').value = '';
				document.getElementById('profit-preview').style.display = 'none';
				clearImagePreview();
			}
			document.getElementById('menu-item-modal').classList.add('show');
		}

		function closeMenuItemModal() {
			document.getElementById('menu-item-modal').classList.remove('show');
			currentEditingMenuItem = null;
		}

		function editMenuItem(itemId) {
			openMenuItemModal(itemId);
		}

		// Manejar carga de imagen
		function handleImageUpload(input) {
			if (input.files && input.files[0]) {
				const reader = new FileReader();
				reader.onload = function(e) {
					const imageData = e.target.result;
					document.getElementById('item-image').value = imageData;
					showImagePreview(imageData);
				};
				reader.readAsDataURL(input.files[0]);
			}
		}

		function showImagePreview(imageUrl) {
			if (!imageUrl) {
				document.getElementById('item-image-preview').innerHTML = '';
				return;
			}
			document.getElementById('item-image-preview').innerHTML = `
				<div style="position: relative; display: inline-block;">
					<img src="${imageUrl}" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 2px solid var(--accent);">
					<button onclick="clearImagePreview()" style="position: absolute; top: 5px; right: 5px; background: var(--danger); color: #fff; border: 0; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">âœ•</button>
				</div>
			`;
		}

		function clearImagePreview() {
			document.getElementById('item-image').value = '';
			document.getElementById('item-image-file').value = '';
			document.getElementById('item-image-preview').innerHTML = '';
		}

		function updateProfitPreview() {
			const cost = parseFloat(document.getElementById('item-cost').value) || 0;
			const price = parseFloat(document.getElementById('item-price').value) || 0;
			
			if (price > 0 && cost >= 0) {
				const profit = price - cost;
				const margin = ((profit / price) * 100).toFixed(1);
				
				document.getElementById('profit-amount').textContent = Utils.formatCurrency(profit);
				document.getElementById('profit-margin').textContent = margin + '%';
				document.getElementById('profit-preview').style.display = 'block';
			} else {
				document.getElementById('profit-preview').style.display = 'none';
			}
		}

		async function saveMenuItem() {
			const name = document.getElementById('item-name').value.trim();
			const description = document.getElementById('item-description').value.trim();
			const category = document.getElementById('item-category').value.trim();
			const cost = parseFloat(document.getElementById('item-cost').value) || 0;
			const price = parseFloat(document.getElementById('item-price').value);
			const available = document.getElementById('item-available').checked;
			const image = document.getElementById('item-image').value.trim();

			if (!name || !category || !price) {
				Utils.showNotification('Completa los campos requeridos', 'warning');
				return;
			}

			if (currentEditingMenuItem) {
				currentEditingMenuItem.name = name;
				currentEditingMenuItem.description = description;
				currentEditingMenuItem.category = category;
				currentEditingMenuItem.cost = cost;
				currentEditingMenuItem.price = price;
				currentEditingMenuItem.available = available;
				currentEditingMenuItem.image = image;
				const index = AppState.menuItems.findIndex(i => i.id === currentEditingMenuItem.id);
				AppState.menuItems[index] = currentEditingMenuItem;
			} else {
				AppState.menuItems.push({
					id: Utils.generateId(),
					name,
					description,
					category,
					cost,
					price,
					available,
					image
				});
			}

			await API.save('menu_items', AppState.menuItems);
			closeMenuItemModal();
			renderMenuConfig();
			Utils.showNotification('Producto guardado', 'success');
		}

		async function deleteMenuItem(itemId) {
			if (!confirm('Â¿Eliminar este producto?')) return;
			AppState.menuItems = AppState.menuItems.filter(i => i.id !== itemId);
			await API.save('menu_items', AppState.menuItems);
			renderMenuConfig();
			Utils.showNotification('Producto eliminado', 'success');
		}

		async function toggleProductAvailability(itemId) {
			const item = AppState.menuItems.find(i => i.id === itemId);
			if (!item) return;
			
			// Cambiar el estado
			item.available = !item.available;
			
			// Actualizar UI inmediatamente
			renderMenuConfig();
			
			// Guardar en servidor en segundo plano
			API.save('menu_items', AppState.menuItems).catch(error => {
				console.error('Error guardando disponibilidad:', error);
				// Revertir cambio si falla
				item.available = !item.available;
				renderMenuConfig();
				alert('âš ï¸ Error al actualizar. Intenta de nuevo.');
			});
		}

		// TRANSACCIONES
		function renderTransactions() {
			const tbody = document.querySelector('#transactions-table tbody');
			const sorted = [...AppState.transactions].sort((a, b) => 
				new Date(b.date) - new Date(a.date)
			);
			
			if (sorted.length === 0) {
				tbody.innerHTML = '<tr><td colspan="5" class="text-center" style="color: var(--muted); padding: 40px;">No hay transacciones registradas</td></tr>';
				return;
			}

			tbody.innerHTML = sorted.map(t => `
				<tr>
					<td>${Utils.formatDate(t.date)}</td>
					<td>Mesa ${t.tableNumber || '-'}</td>
					<td>${t.concept}</td>
					<td style="color: var(--success); font-weight: 600;">${Utils.formatCurrency(t.amount)}</td>
					<td>
						<button class="btn btn-small btn-danger" onclick="deleteTransaction('${t.id}')">ğŸ—‘ï¸</button>
					</td>
				</tr>
			`).join('');
		}

		async function deleteTransaction(transactionId) {
			if (!confirm('Â¿Eliminar esta transacciÃ³n?')) return;
			AppState.transactions = AppState.transactions.filter(t => t.id !== transactionId);
			await API.save('transactions', AppState.transactions);
			renderTransactions();
			renderDashboard();
			Utils.showNotification('TransacciÃ³n eliminada', 'success');
		}

		// VER DETALLE DE MESA
		// MODAL DE PEDIDOS
		let currentOrderTable = null;
		let currentOrderItems = [];

		function openOrderModal(tableId) {
			const table = AppState.tables.find(t => t.id === tableId);
			if (!table) return;

			currentOrderTable = table;
			
			// Si la mesa ya tiene un pedido, cargar sus items
			if (table.currentOrder) {
				const existingOrder = AppState.orders.find(o => o.id === table.currentOrder);
				if (existingOrder) {
					currentOrderItems = JSON.parse(JSON.stringify(existingOrder.items));
				}
			} else {
				currentOrderItems = [];
			}

			document.getElementById('order-modal-title').textContent = `Mesa ${table.number} - ${table.currentOrder ? 'Editar' : 'Nuevo'} Pedido`;
			renderOrderModalMenu();
			updateOrderSummary();
			document.getElementById('order-modal').classList.add('show');
		}

		function closeOrderModal() {
			document.getElementById('order-modal').classList.remove('show');
			currentOrderTable = null;
			currentOrderItems = [];
		}

		function renderOrderModalMenu() {
			const categories = [...new Set(AppState.menuItems.filter(i => i.available).map(i => i.category))];
			const container = document.getElementById('order-menu-items');
			
			container.innerHTML = categories.map(category => `
				<div style="margin-bottom: 25px;">
					<h4 style="color: var(--accent); margin-bottom: 15px; border-bottom: 2px solid var(--accent); padding-bottom: 8px;">${category}</h4>
					<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
						${AppState.menuItems
							.filter(item => item.category === category && item.available)
							.map(item => `
								<div class="menu-item-btn" onclick="addItemToOrder('${item.id}')" style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent;" onmouseover="this.style.borderColor='var(--accent)'; this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.borderColor='transparent'; this.style.background='rgba(255,255,255,0.05)'">
									<div style="font-weight: 600; margin-bottom: 5px;">${item.name}</div>
									<div style="color: var(--accent); font-size: 18px; font-weight: 700;">${Utils.formatCurrency(item.price)}</div>
								</div>
							`).join('')}
					</div>
				</div>
			`).join('');
		}

		function addItemToOrder(itemId) {
			const menuItem = AppState.menuItems.find(i => i.id === itemId);
			if (!menuItem) return;

			const existingItem = currentOrderItems.find(i => i.menuItemId === itemId && !i.notes);
			
			if (existingItem) {
				existingItem.quantity++;
			} else {
				currentOrderItems.push({
					menuItemId: itemId,
					name: menuItem.name,
					price: menuItem.price,
					quantity: 1,
					notes: ''
				});
			}

			updateOrderSummary();
		}

		function updateOrderSummary() {
			const container = document.getElementById('order-items-summary');
			
			if (currentOrderItems.length === 0) {
				container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 20px;">No hay productos en el pedido</p>';
				document.getElementById('order-total-amount').textContent = Utils.formatCurrency(0);
				return;
			}

			const total = currentOrderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
			
			container.innerHTML = currentOrderItems.map((item, index) => `
				<div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--accent);">
					<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
						<strong>${item.name}</strong>
						<button class="btn btn-small btn-danger" onclick="removeItemFromOrder(${index})" style="padding: 4px 8px;">ğŸ—‘ï¸</button>
					</div>
					<div style="display: flex; gap: 10px; align-items: center;">
						<button onclick="changeQuantity(${index}, -1)" style="width: 30px; height: 30px; border-radius: 50%; border: 0; background: #ffffff; color: #000000; cursor: pointer; font-size: 18px;">-</button>
						<span style="font-size: 18px; font-weight: 700; min-width: 30px; text-align: center;">${item.quantity}</span>
						<button onclick="changeQuantity(${index}, 1)" style="width: 30px; height: 30px; border-radius: 50%; border: 0; background: #ffffff; color: #000000; cursor: pointer; font-size: 18px;">+</button>
						<span style="margin-left: auto; color: var(--accent); font-weight: 700;">${Utils.formatCurrency(item.price * item.quantity)}</span>
					</div>
					<textarea placeholder="Notas especiales..." onchange="updateItemNotes(${index}, this.value)" style="width: 100%; margin-top: 8px; min-height: 40px; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--text); font-size: 13px;">${item.notes || ''}</textarea>
				</div>
			`).join('');
			
			document.getElementById('order-total-amount').textContent = Utils.formatCurrency(total);
		}

		function changeQuantity(index, delta) {
			if (currentOrderItems[index]) {
				currentOrderItems[index].quantity += delta;
				if (currentOrderItems[index].quantity <= 0) {
					currentOrderItems.splice(index, 1);
				}
				updateOrderSummary();
			}
		}

		function removeItemFromOrder(index) {
			currentOrderItems.splice(index, 1);
			updateOrderSummary();
		}

		function updateItemNotes(index, notes) {
			if (currentOrderItems[index]) {
				currentOrderItems[index].notes = notes;
			}
		}

	let isSavingOrder = false;

	async function saveOrderFromModal() {
		if (isSavingOrder) {
			Utils.showNotification('Guardando pedido, por favor espera...', 'warning');
			return;
		}
		
		if (!currentOrderTable || currentOrderItems.length === 0) {
			alert('âš ï¸ Agrega al menos un producto');
			return;
		}

		isSavingOrder = true;
		Utils.showNotification('Guardando pedido...', 'info');

		try {
			// Pausar auto-refresh
			if (autoRefreshInterval) {
				clearInterval(autoRefreshInterval);
			}

			const total = currentOrderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

			// Encontrar la mesa en el estado global
			const tableInState = AppState.tables.find(t => t.id === currentOrderTable.id);
			if (!tableInState) {
				throw new Error('Mesa no encontrada');
			}

			if (tableInState.currentOrder) {
				// Actualizar pedido existente
				const order = AppState.orders.find(o => o.id === tableInState.currentOrder);
				if (order) {
					order.items = [...currentOrderItems];
					order.total = total;
					order.updatedAt = new Date().toISOString();
				}
			} else {
				// Crear nuevo pedido
				const newOrder = {
					id: Utils.generateId(),
					tableId: tableInState.id,
					tableNumber: tableInState.number,
					items: [...currentOrderItems],
					total: total,
					status: 'pending',
					createdAt: new Date().toISOString()
				};
				AppState.orders.push(newOrder);
				
				// Actualizar la mesa en el estado global
				tableInState.currentOrder = newOrder.id;
				tableInState.status = 'occupied';
			}

			// GUARDAR EN SERVIDOR Y ESPERAR CONFIRMACIÃ“N
			await Promise.all([
				API.save('orders', AppState.orders),
				API.save('tables', AppState.tables)
			]);

			// RECARGAR desde servidor para garantizar sincronizaciÃ³n
			await loadInitialData();

			// Cerrar modal y actualizar UI
			closeOrderModal();
			renderAllSections();

			Utils.showNotification('Pedido guardado exitosamente', 'success');

		} catch (error) {
			console.error('Error guardando pedido:', error);
			
			// REVERTIR recargando desde servidor
			await loadInitialData();
			renderAllSections();
			
			Utils.showNotification('Error al guardar pedido', 'error');
			alert('âŒ Error al guardar el pedido:\n\n' + error.message + '\n\nVerifica tu conexiÃ³n e intenta nuevamente.');
			
		} finally {
			isSavingOrder = false;
			startAutoRefresh();
		}
	}		function viewTableDetails(tableId) {
			const table = AppState.tables.find(t => t.id === tableId);
			if (!table || !table.currentOrder) return;

			const order = AppState.orders.find(o => o.id === table.currentOrder);
			if (!order) return;

			document.getElementById('table-detail-title').textContent = `Mesa ${table.number} - Detalle`;
			
			const content = document.getElementById('table-detail-content');
			content.innerHTML = `
				<div style="margin-bottom: 20px;">
					<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
						<div>
							<strong style="color: var(--accent); font-size: 18px;">Mesa ${table.number}</strong>
							<div class="small" style="color: var(--muted);">${Utils.formatDate(order.createdAt)}</div>
						</div>
						<span class="badge badge-warning">Activo</span>
					</div>
					
					<div class="order-items-list" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
						<h4 style="color: var(--accent); margin-bottom: 10px;">Productos</h4>
						${order.items.map(item => `
							<div class="order-item-line" style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
								<div>
									<strong>${item.quantity}x ${item.name}</strong>
									${item.notes ? `<br><small style="color: var(--muted); font-size: 12px;">Nota: ${item.notes}</small>` : ''}
								</div>
								<div style="color: var(--success); font-weight: 600;">
									${Utils.formatCurrency(item.price * item.quantity)}
								</div>
							</div>
						`).join('')}
					</div>
					
					<div style="text-align: right; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; border: 2px solid var(--success);">
						<div style="font-size: 14px; color: var(--muted); margin-bottom: 5px;">Total a Pagar</div>
						<div style="font-size: 28px; font-weight: 700; color: var(--success);">
							${Utils.formatCurrency(order.total)}
						</div>
					</div>
					
					<div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
						<button class="btn btn-warning" onclick="generateInvoicePDFFromModal('${order.id}')">ğŸ“„ Generar PDF</button>
						<button class="btn btn-success" onclick="completeOrderFromModal('${order.id}')">âœ“ Completar y Facturar</button>
						<button class="btn btn-secondary" onclick="closeTableDetailModal()">Cerrar</button>
					</div>
				</div>
			`;
			
			document.getElementById('table-detail-modal').classList.add('show');
		}

		function closeTableDetailModal() {
			document.getElementById('table-detail-modal').classList.remove('show');
		}

		async function generateInvoicePDFFromModal(orderId) {
			const order = AppState.orders.find(o => o.id === orderId);
			if (order) {
				await generateInvoicePDF(order);
				Utils.showNotification('PDF generado', 'success');
			}
		}

		async function completeOrderFromModal(orderId) {
			closeTableDetailModal();
			await completeOrder(orderId);
		}

		// CIERRE DE CAJA
		async function generateCloseCash() {
			const today = new Date().toISOString().split('T')[0];
			const todayTransactions = AppState.transactions.filter(t => t.date && t.date.startsWith(today));
			
			const totalSales = todayTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
			const totalOrders = todayTransactions.length;
			const completedOrders = AppState.orders.filter(o => 
				o.status === 'completed' && o.completedAt && o.completedAt.startsWith(today)
			).length;

			const container = document.getElementById('close-cash-content');
			container.innerHTML = `
				<div class="close-cash-summary">
					<h2>Cierre de Caja - ${new Date().toLocaleDateString('es-MX')}</h2>
					<div class="close-cash-line">
						<span>Total de Ventas:</span>
						<span>${totalOrders}</span>
					</div>
					<div class="close-cash-line">
						<span>Pedidos Completados:</span>
						<span>${completedOrders}</span>
					</div>
					<div class="close-cash-line">
						<span>Ingreso Bruto:</span>
						<span>${Utils.formatCurrency(totalSales)}</span>
					</div>
					<div class="close-cash-total">
						Total del DÃ­a: ${Utils.formatCurrency(totalSales)}
					</div>
					<div style="margin-top: 20px; display: flex; gap: 10px;">
						<button class="btn" onclick="generateCloseCashPDF()">ğŸ“„ Ver PDF</button>
						<button class="btn btn-success" onclick="saveCloseCash()">ğŸ’¾ Guardar Cierre</button>
					</div>
				</div>
			`;

			document.getElementById('closure-history').style.display = 'none';
		}

		async function saveCloseCash() {
			const today = new Date().toISOString().split('T')[0];
			const todayTransactions = AppState.transactions.filter(t => t.date && t.date.startsWith(today));
			
			// Verificar si ya existe un cierre para hoy
			const existingClosure = AppState.cashClosures.find(c => c.date === today);
			if (existingClosure) {
				if (!confirm('Ya existe un cierre para hoy. Â¿Deseas actualizarlo?')) return;
			}

			const totalSales = todayTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
			const completedOrders = AppState.orders.filter(o => 
				o.status === 'completed' && o.completedAt && o.completedAt.startsWith(today)
			).length;

			const closure = {
				id: existingClosure ? existingClosure.id : Utils.generateId(),
				date: today,
				totalTransactions: todayTransactions.length,
				totalSales: totalSales,
				completedOrders: completedOrders,
				transactions: todayTransactions,
				createdAt: existingClosure ? existingClosure.createdAt : new Date().toISOString(),
				updatedAt: new Date().toISOString()
			};

			if (existingClosure) {
				const index = AppState.cashClosures.findIndex(c => c.id === closure.id);
				AppState.cashClosures[index] = closure;
			} else {
				AppState.cashClosures.push(closure);
			}

			await API.save('cash_closures', AppState.cashClosures);
			Utils.showNotification('Cierre de caja guardado correctamente', 'success');
		}

		function viewClosureHistory() {
			document.getElementById('close-cash-content').innerHTML = `
				<p class="text-center" style="color: var(--muted); padding: 40px;">
					Selecciona "Generar Cierre Actual" para ver el resumen del dÃ­a o revisa el historial abajo
				</p>
			`;
			
			const historyDiv = document.getElementById('closure-history');
			historyDiv.style.display = 'block';
			
			const tbody = document.querySelector('#closures-table tbody');
			const sorted = [...AppState.cashClosures].sort((a, b) => 
				new Date(b.date) - new Date(a.date)
			);
			
			if (sorted.length === 0) {
				tbody.innerHTML = '<tr><td colspan="4" class="text-center" style="color: var(--muted); padding: 40px;">No hay cierres guardados</td></tr>';
				return;
			}

			tbody.innerHTML = sorted.map(closure => `
				<tr>
					<td>${new Date(closure.date).toLocaleDateString('es-MX')}</td>
					<td>${closure.totalTransactions} ventas</td>
					<td style="color: var(--success); font-weight: 600;">${Utils.formatCurrency(closure.totalSales)}</td>
					<td>
						<button class="btn btn-small btn-warning" onclick="viewClosureDetail('${closure.id}')">ğŸ‘ï¸ Ver</button>
						<button class="btn btn-small btn-secondary" onclick="generateClosurePDF('${closure.id}')">ğŸ“„ PDF</button>
						<button class="btn btn-small btn-danger" onclick="deleteClosure('${closure.id}')">ğŸ—‘ï¸</button>
					</td>
				</tr>
			`).join('');
		}

		function viewClosureDetail(closureId) {
			const closure = AppState.cashClosures.find(c => c.id === closureId);
			if (!closure) return;

			const container = document.getElementById('close-cash-content');
			container.innerHTML = `
				<div class="close-cash-summary">
					<h2>Cierre de Caja - ${new Date(closure.date).toLocaleDateString('es-MX')}</h2>
					<div class="close-cash-line">
						<span>Total de Ventas:</span>
						<span>${closure.totalTransactions}</span>
					</div>
					<div class="close-cash-line">
						<span>Pedidos Completados:</span>
						<span>${closure.completedOrders}</span>
					</div>
					<div class="close-cash-line">
						<span>Ingreso Bruto:</span>
						<span>${Utils.formatCurrency(closure.totalSales)}</span>
					</div>
					<div class="close-cash-total">
						Total del DÃ­a: ${Utils.formatCurrency(closure.totalSales)}
					</div>
					<div style="margin-top: 20px;">
						<button class="btn" onclick="generateClosurePDF('${closure.id}')">ğŸ“„ Ver PDF</button>
					</div>
				</div>
			`;

			window.scrollTo({ top: 0, behavior: 'smooth' });
		}

		function generateClosurePDF(closureId) {
			const closure = AppState.cashClosures.find(c => c.id === closureId);
			if (!closure) return;

			const { jsPDF } = window.jspdf;
			const doc = new jsPDF();
			
			doc.setFontSize(20);
			doc.text('CIERRE DE CAJA', 105, 20, { align: 'center' });
			doc.setFontSize(12);
			doc.text(`Fecha: ${new Date(closure.date).toLocaleDateString('es-MX')}`, 105, 30, { align: 'center' });
			
			doc.setLineWidth(0.5);
			doc.line(20, 35, 190, 35);
			
			let y = 48;
			doc.setFontSize(14);
			doc.text('Resumen del DÃ­a', 20, y);
			y += 10;
			
			doc.setFontSize(11);
			doc.text(`Total de Transacciones: ${closure.totalTransactions}`, 20, y);
			y += 8;
			doc.text(`Pedidos Completados: ${closure.completedOrders}`, 20, y);
			y += 8;
			doc.text(`Ingresos Totales: ${Utils.formatCurrency(closure.totalSales)}`, 20, y);
			y += 15;
			
			if (closure.transactions && closure.transactions.length > 0) {
				doc.setFontSize(14);
				doc.text('Detalle de Transacciones', 20, y);
				y += 8;
				
				doc.setFontSize(9);
				closure.transactions.forEach(t => {
					if (y > 270) {
						doc.addPage();
						y = 20;
					}
					doc.text(`${new Date(t.date).toLocaleTimeString('es-MX')} - Mesa ${t.tableNumber || '-'} - ${Utils.formatCurrency(t.amount)}`, 20, y);
					y += 6;
				});
			}
			
			const pdfBlob = doc.output('blob');
			const pdfUrl = URL.createObjectURL(pdfBlob);
			window.open(pdfUrl, '_blank');
		}

		async function deleteClosure(closureId) {
			if (!confirm('Â¿Eliminar este cierre de caja?')) return;
			AppState.cashClosures = AppState.cashClosures.filter(c => c.id !== closureId);
			await API.save('cash_closures', AppState.cashClosures);
			viewClosureHistory();
			Utils.showNotification('Cierre eliminado', 'success');
		}

		// GENERAR PDF FACTURA
		async function generateInvoicePDF(order) {
			const { jsPDF } = window.jspdf;
			const doc = new jsPDF({
				unit: 'mm',
				format: [80, 200] // Formato ticket POS
			});

			doc.setFontSize(16);
			doc.text('RESTAURANTE', 40, 10, { align: 'center' });
			doc.setFontSize(10);
			doc.text('Ticket de Venta', 40, 16, { align: 'center' });
			doc.text('------------------------', 40, 20, { align: 'center' });
			
			doc.setFontSize(9);
			doc.text(`Mesa: ${order.tableNumber}`, 5, 26);
			doc.text(`Fecha: ${new Date(order.createdAt).toLocaleString('es-MX')}`, 5, 31);
			doc.text('------------------------', 40, 35, { align: 'center' });
			
			let y = 40;
			doc.setFontSize(8);
			order.items.forEach(item => {
				doc.text(`${item.quantity}x ${item.name}`, 5, y);
				doc.text(`$${(item.price * item.quantity).toFixed(2)}`, 70, y, { align: 'right' });
				y += 5;
				if (item.notes) {
					doc.setFontSize(7);
					doc.text(`  Nota: ${item.notes}`, 5, y);
					y += 4;
					doc.setFontSize(8);
				}
			});
			
			doc.text('------------------------', 40, y, { align: 'center' });
			y += 5;
			doc.setFontSize(12);
			doc.text(`TOTAL: $${order.total.toFixed(2)}`, 40, y, { align: 'center' });
			y += 7;
			doc.setFontSize(8);
			doc.text('Gracias por su preferencia', 40, y, { align: 'center' });
			
			// Abrir en nueva pestaÃ±a para visualizar
			const pdfBlob = doc.output('blob');
			const pdfUrl = URL.createObjectURL(pdfBlob);
			window.open(pdfUrl, '_blank');
		}

		// GENERAR PDF CIERRE DE CAJA
		function generateCloseCashPDF() {
			const { jsPDF } = window.jspdf;
			const doc = new jsPDF();
			
			const today = new Date().toISOString().split('T')[0];
			const todayTransactions = AppState.transactions.filter(t => t.date && t.date.startsWith(today));
			const totalSales = todayTransactions.reduce((sum, t) => sum + (t.amount || 0), 0);
			
			doc.setFontSize(20);
			doc.text('CIERRE DE CAJA', 105, 20, { align: 'center' });
			doc.setFontSize(12);
			doc.text(`Fecha: ${new Date().toLocaleDateString('es-MX')}`, 105, 30, { align: 'center' });
			doc.text(`Hora: ${new Date().toLocaleTimeString('es-MX')}`, 105, 37, { align: 'center' });
			
			doc.setLineWidth(0.5);
			doc.line(20, 42, 190, 42);
			
			let y = 55;
			doc.setFontSize(14);
			doc.text('Resumen del DÃ­a', 20, y);
			y += 10;
			
			doc.setFontSize(11);
			doc.text(`Total de Transacciones: ${todayTransactions.length}`, 20, y);
			y += 8;
			doc.text(`Ingresos Totales: ${Utils.formatCurrency(totalSales)}`, 20, y);
			y += 15;
			
			doc.setFontSize(14);
			doc.text('Detalle de Transacciones', 20, y);
			y += 8;
			
			doc.setFontSize(9);
			todayTransactions.forEach(t => {
				if (y > 270) {
					doc.addPage();
					y = 20;
				}
				doc.text(`${new Date(t.date).toLocaleTimeString('es-MX')} - Mesa ${t.tableNumber || '-'} - ${Utils.formatCurrency(t.amount)}`, 20, y);
				y += 6;
			});
			
			// Abrir en nueva pestaÃ±a para visualizar
			const pdfBlob = doc.output('blob');
			const pdfUrl = URL.createObjectURL(pdfBlob);
			window.open(pdfUrl, '_blank');
		}

		// Funciones para menÃº mÃ³vil
		function toggleMobileMenu() {
			const sidebar = document.getElementById('sidebar');
			const overlay = document.querySelector('.mobile-overlay');
			sidebar.classList.toggle('mobile-open');
			overlay.classList.toggle('active');
		}
		
		function closeMobileMenu() {
			const sidebar = document.getElementById('sidebar');
			const overlay = document.querySelector('.mobile-overlay');
			sidebar.classList.remove('mobile-open');
			overlay.classList.remove('active');
		}
		
		// RENTABILIDAD
		function renderProfitability() {
			generateProfitabilityReport();
		}

		// Variables globales para charts
		let salesByDayChart = null;
		let topProductsChart = null;
		let profitByMonthChart = null;
		let categoryChart = null;

		function generateProfitabilityReport() {
			// Verificar si hay productos sin costo
			const productsWithoutCost = AppState.menuItems.filter(item => !item.cost || item.cost === 0);
			const warningDiv = document.getElementById('cost-warning');
			if (productsWithoutCost.length > 0) {
				warningDiv.style.display = 'block';
			} else {
				warningDiv.style.display = 'none';
			}

			const completedOrders = AppState.orders.filter(o => o.status === 'completed');

			// Calcular ventas por producto
			const productSales = {};
			
			completedOrders.forEach(order => {
				order.items.forEach(item => {
					if (!productSales[item.menuItemId]) {
						const menuItem = AppState.menuItems.find(m => m.id === item.menuItemId);
						productSales[item.menuItemId] = {
							name: item.name,
							cost: menuItem?.cost || 0,
							price: item.price,
							quantity: 0,
							totalSales: 0,
							totalCost: 0,
							category: menuItem?.category || 'Sin CategorÃ­a'
						};
					}
					productSales[item.menuItemId].quantity += item.quantity;
					productSales[item.menuItemId].totalSales += item.price * item.quantity;
					productSales[item.menuItemId].totalCost += (productSales[item.menuItemId].cost * item.quantity);
				});
			});

			// === MÃ‰TRICAS PRINCIPALES ===
			const today = new Date().toISOString().split('T')[0];
			const thisMonth = new Date().toISOString().slice(0, 7);
			
			let profitToday = 0;
			let profitMonth = 0;
			let salesToday = 0;
			let salesMonth = 0;
			let ordersMonthCount = 0;
			
			completedOrders.forEach(order => {
				const orderDate = order.completedAt ? order.completedAt.split('T')[0] : '';
				const orderMonth = order.completedAt ? order.completedAt.slice(0, 7) : '';
				
				let orderTotal = 0;
				order.items.forEach(item => {
					const menuItem = AppState.menuItems.find(m => m.id === item.menuItemId);
					const cost = menuItem?.cost || 0;
					const profit = (item.price - cost) * item.quantity;
					const sale = item.price * item.quantity;
					
					orderTotal += sale;
					
					if (orderDate === today) {
						profitToday += profit;
						salesToday += sale;
					}
					if (orderMonth === thisMonth) {
						profitMonth += profit;
						salesMonth += sale;
					}
				});
				
				if (orderMonth === thisMonth) ordersMonthCount++;
			});

			// Actualizar mÃ©tricas principales
			document.getElementById('profit-today').textContent = Utils.formatCurrency(profitToday);
			document.getElementById('profit-month').textContent = Utils.formatCurrency(profitMonth);
			document.getElementById('orders-month-count').textContent = `${ordersMonthCount} Ã³rdenes`;
			
			const products = Object.values(productSales);
			
			// Margen promedio
			if (products.length > 0) {
				const avgMargin = products.reduce((sum, p) => {
					const margin = p.totalSales > 0 ? ((p.totalSales - p.totalCost) / p.totalSales) * 100 : 0;
					return sum + margin;
				}, 0) / products.length;
				document.getElementById('margin-avg').textContent = avgMargin.toFixed(1) + '%';
				
				// Producto mÃ¡s rentable
				const mostProfitable = products.reduce((max, p) => {
					const profit = p.totalSales - p.totalCost;
					const maxProfit = max.totalSales - max.totalCost;
					return profit > maxProfit ? p : max;
				}, products[0]);
				document.getElementById('most-profitable').textContent = mostProfitable.name;
				document.getElementById('most-profitable-profit').textContent = Utils.formatCurrency(mostProfitable.totalSales - mostProfitable.totalCost);
				
				// Producto mÃ¡s vendido
				const mostSold = products.reduce((max, p) => p.quantity > max.quantity ? p : max, products[0]);
				document.getElementById('most-sold').textContent = mostSold.name;
				document.getElementById('most-sold-quantity').textContent = `${mostSold.quantity} unidades`;
			} else {
				document.getElementById('margin-avg').textContent = '0%';
				document.getElementById('most-profitable').textContent = '-';
				document.getElementById('most-profitable-profit').textContent = '-';
				document.getElementById('most-sold').textContent = '-';
				document.getElementById('most-sold-quantity').textContent = '-';
			}

			// Ticket promedio
			const avgTicket = completedOrders.length > 0 ? salesMonth / ordersMonthCount : 0;
			document.getElementById('avg-ticket').textContent = Utils.formatCurrency(avgTicket);
			document.getElementById('total-tickets').textContent = `${completedOrders.length} Ã³rdenes totales`;

			// === GRÃFICA: VENTAS POR DÃA (Ãšltimos 7 dÃ­as) ===
			const last7Days = [];
			const salesByDay = {};
			for (let i = 6; i >= 0; i--) {
				const date = new Date();
				date.setDate(date.getDate() - i);
				const dateStr = date.toISOString().split('T')[0];
				last7Days.push(dateStr);
				salesByDay[dateStr] = 0;
			}

			completedOrders.forEach(order => {
				const orderDate = order.completedAt ? order.completedAt.split('T')[0] : '';
				if (salesByDay.hasOwnProperty(orderDate)) {
					order.items.forEach(item => {
						salesByDay[orderDate] += item.price * item.quantity;
					});
				}
			});

			if (salesByDayChart) salesByDayChart.destroy();
			const ctxDay = document.getElementById('sales-by-day-chart').getContext('2d');
			salesByDayChart = new Chart(ctxDay, {
				type: 'line',
				data: {
					labels: last7Days.map(d => {
						const date = new Date(d + 'T00:00:00');
						return date.toLocaleDateString('es-MX', { weekday: 'short', day: 'numeric' });
					}),
					datasets: [{
						label: 'Ventas',
						data: last7Days.map(d => salesByDay[d]),
						borderColor: '#ffffff',
						backgroundColor: 'rgba(255, 255, 255, 0.1)',
						borderWidth: 3,
						fill: true,
						tension: 0.4,
						pointBackgroundColor: '#ffffff',
						pointBorderColor: '#000000',
						pointBorderWidth: 2,
						pointRadius: 5,
						pointHoverRadius: 7
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: true,
					plugins: {
						legend: { display: false },
						tooltip: {
							backgroundColor: '#000',
							titleColor: '#fff',
							bodyColor: '#fff',
							borderColor: '#fff',
							borderWidth: 1,
							callbacks: {
								label: (context) => 'Ventas: ' + Utils.formatCurrency(context.parsed.y)
							}
						}
					},
					scales: {
						y: {
							beginAtZero: true,
							ticks: { color: '#e0e0e0' },
							grid: { color: 'rgba(255, 255, 255, 0.1)' }
						},
						x: {
							ticks: { color: '#e0e0e0' },
							grid: { display: false }
						}
					}
				}
			});

			// === GRÃFICA: TOP 5 PRODUCTOS MÃS VENDIDOS ===
			const top5Products = products.sort((a, b) => b.quantity - a.quantity).slice(0, 5);
			
			if (topProductsChart) topProductsChart.destroy();
			const ctxTop = document.getElementById('top-products-chart').getContext('2d');
			topProductsChart = new Chart(ctxTop, {
				type: 'bar',
				data: {
					labels: top5Products.map(p => p.name),
					datasets: [{
						label: 'Unidades Vendidas',
						data: top5Products.map(p => p.quantity),
						backgroundColor: [
							'rgba(255, 107, 53, 0.8)',
							'rgba(255, 152, 0, 0.8)',
							'rgba(76, 175, 80, 0.8)',
							'rgba(33, 150, 243, 0.8)',
							'rgba(156, 39, 176, 0.8)'
						],
						borderColor: '#ffffff',
						borderWidth: 2
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: true,
					plugins: {
						legend: { display: false },
						tooltip: {
							backgroundColor: '#000',
							titleColor: '#fff',
							bodyColor: '#fff',
							borderColor: '#fff',
							borderWidth: 1
						}
					},
					scales: {
						y: {
							beginAtZero: true,
							ticks: { color: '#e0e0e0', stepSize: 1 },
							grid: { color: 'rgba(255, 255, 255, 0.1)' }
						},
						x: {
							ticks: { color: '#e0e0e0' },
							grid: { display: false }
						}
					}
				}
			});

			// === GRÃFICA: GANANCIAS POR MES (Ãšltimos 6 meses) ===
			const last6Months = [];
			const profitByMonth = {};
			for (let i = 5; i >= 0; i--) {
				const date = new Date();
				date.setMonth(date.getMonth() - i);
				const monthStr = date.toISOString().slice(0, 7);
				last6Months.push(monthStr);
				profitByMonth[monthStr] = 0;
			}

			completedOrders.forEach(order => {
				const orderMonth = order.completedAt ? order.completedAt.slice(0, 7) : '';
				if (profitByMonth.hasOwnProperty(orderMonth)) {
					order.items.forEach(item => {
						const menuItem = AppState.menuItems.find(m => m.id === item.menuItemId);
						const cost = menuItem?.cost || 0;
						const profit = (item.price - cost) * item.quantity;
						profitByMonth[orderMonth] += profit;
					});
				}
			});

			if (profitByMonthChart) profitByMonthChart.destroy();
			const ctxMonth = document.getElementById('profit-by-month-chart').getContext('2d');
			profitByMonthChart = new Chart(ctxMonth, {
				type: 'bar',
				data: {
					labels: last6Months.map(m => {
						const [year, month] = m.split('-');
						const date = new Date(year, month - 1);
						return date.toLocaleDateString('es-MX', { month: 'short', year: 'numeric' });
					}),
					datasets: [{
						label: 'Ganancias',
						data: last6Months.map(m => profitByMonth[m]),
						backgroundColor: 'rgba(76, 175, 80, 0.8)',
						borderColor: '#ffffff',
						borderWidth: 2
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: true,
					plugins: {
						legend: { display: false },
						tooltip: {
							backgroundColor: '#000',
							titleColor: '#fff',
							bodyColor: '#fff',
							borderColor: '#fff',
							borderWidth: 1,
							callbacks: {
								label: (context) => 'Ganancia: ' + Utils.formatCurrency(context.parsed.y)
							}
						}
					},
					scales: {
						y: {
							beginAtZero: true,
							ticks: { color: '#e0e0e0' },
							grid: { color: 'rgba(255, 255, 255, 0.1)' }
						},
						x: {
							ticks: { color: '#e0e0e0' },
							grid: { display: false }
						}
					}
				}
			});

			// === GRÃFICA: VENTAS POR CATEGORÃA ===
			const salesByCategory = {};
			products.forEach(p => {
				if (!salesByCategory[p.category]) {
					salesByCategory[p.category] = 0;
				}
				salesByCategory[p.category] += p.totalSales;
			});

			const categories = Object.keys(salesByCategory);
			const categoryColors = [
				'rgba(255, 107, 53, 0.8)',
				'rgba(255, 152, 0, 0.8)',
				'rgba(76, 175, 80, 0.8)',
				'rgba(33, 150, 243, 0.8)',
				'rgba(156, 39, 176, 0.8)',
				'rgba(244, 67, 54, 0.8)'
			];

			if (categoryChart) categoryChart.destroy();
			const ctxCat = document.getElementById('category-chart').getContext('2d');
			categoryChart = new Chart(ctxCat, {
				type: 'doughnut',
				data: {
					labels: categories,
					datasets: [{
						data: categories.map(c => salesByCategory[c]),
						backgroundColor: categoryColors.slice(0, categories.length),
						borderColor: '#000000',
						borderWidth: 3
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: true,
					plugins: {
						legend: {
							position: 'bottom',
							labels: { color: '#e0e0e0', padding: 15, font: { size: 12 } }
						},
						tooltip: {
							backgroundColor: '#000',
							titleColor: '#fff',
							bodyColor: '#fff',
							borderColor: '#fff',
							borderWidth: 1,
							callbacks: {
								label: (context) => {
									const label = context.label || '';
									const value = Utils.formatCurrency(context.parsed);
									const total = context.dataset.data.reduce((a, b) => a + b, 0);
									const percentage = ((context.parsed / total) * 100).toFixed(1);
									return `${label}: ${value} (${percentage}%)`;
								}
							}
						}
					}
				}
			});

			// === TABLA DE RENTABILIDAD ===
			const tbody = document.querySelector('#profitability-table tbody');
			tbody.innerHTML = products
				.sort((a, b) => (b.totalSales - b.totalCost) - (a.totalSales - a.totalCost))
				.map(product => {
					const totalProfit = product.totalSales - product.totalCost;
					const margin = product.totalSales > 0 ? ((totalProfit / product.totalSales) * 100).toFixed(1) : 0;
					const noCostConfigured = product.cost === 0;
					
					return `
						<tr>
							<td>
								<strong>${product.name}</strong>
								${noCostConfigured ? '<br><small style="color: #ff9800;">âš ï¸ Sin costo configurado</small>' : ''}
							</td>
							<td>${product.quantity}</td>
							<td>
								${Utils.formatCurrency(product.totalCost)}
								${noCostConfigured ? '<br><small style="color: #999;">Configure en MenÃº</small>' : ''}
							</td>
							<td>${Utils.formatCurrency(product.totalSales)}</td>
							<td style="color: ${totalProfit > 0 ? 'var(--accent)' : '#999'}; font-weight: 700;">
								${Utils.formatCurrency(totalProfit)}
								${noCostConfigured ? '<br><small style="color: #ff9800;">Aproximado</small>' : ''}
							</td>
							<td>
								<span class="badge" style="background: ${noCostConfigured ? '#ff9800' : margin > 50 ? '#4caf50' : margin > 30 ? '#ff9800' : '#999'}; color: #fff;">
									${margin}%
								</span>
							</td>
						</tr>
					`;
				}).join('');
			
			if (products.length === 0) {
				tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--muted); padding: 40px;">No hay datos de ventas para calcular rentabilidad</td></tr>';
			}
		}

		// FunciÃ³n de depuraciÃ³n para verificar datos
		function showDebugInfo() {
			const totalOrders = AppState.orders.length;
			const completedOrders = AppState.orders.filter(o => o.status === 'completed');
			const pendingOrders = AppState.orders.filter(o => o.status === 'pending');
			const cancelledOrders = AppState.orders.filter(o => o.status === 'cancelled');
			
			let message = `ğŸ“Š ESTADO DEL SISTEMA\n\n`;
			message += `Total de Ã³rdenes: ${totalOrders}\n`;
			message += `- Completadas: ${completedOrders.length}\n`;
			message += `- Pendientes: ${pendingOrders.length}\n`;
			message += `- Canceladas: ${cancelledOrders.length}\n\n`;
			
			if (completedOrders.length > 0) {
				message += `ğŸ›’ Ã“RDENES COMPLETADAS:\n`;
				completedOrders.forEach((order, i) => {
					const date = order.completedAt ? new Date(order.completedAt).toLocaleString('es-MX') : 'Sin fecha';
					const items = order.items.length;
					const total = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
					message += `\n${i + 1}. Mesa ${order.tableNumber || '?'} - ${date}\n`;
					message += `   ${items} producto(s) - Total: ${Utils.formatCurrency(total)}\n`;
				});
			} else {
				message += `â„¹ï¸ No hay Ã³rdenes completadas en el sistema.\n`;
				message += `Por eso la secciÃ³n de Rentabilidad estÃ¡ vacÃ­a.\n\n`;
				message += `Para ver datos de rentabilidad:\n`;
				message += `1. Ve a "Dashboard"\n`;
				message += `2. Toma un pedido en una mesa\n`;
				message += `3. Completa la orden\n`;
				message += `4. Regresa a "Rentabilidad" para ver los datos`;
			}
			
			alert(message);
		}

		// CONFIGURACIÃ“N DEL SISTEMA
		async function resetSalesData() {
			const confirmation = prompt(
				'âš ï¸ ADVERTENCIA: Esta acciÃ³n eliminarÃ¡ TODOS los datos de ventas de forma PERMANENTE.\n\n' +
				'Se eliminarÃ¡n:\n' +
				'â€¢ Todas las Ã³rdenes\n' +
				'â€¢ Todas las transacciones\n' +
				'â€¢ Todos los cierres de caja\n' +
				'â€¢ El estado de las mesas se resetearÃ¡\n\n' +
				'Los productos del menÃº y meseros NO se eliminarÃ¡n.\n\n' +
				'Escribe "CONFIRMAR" (en mayÃºsculas) para proceder:'
			);

			if (confirmation !== 'CONFIRMAR') {
				alert('OperaciÃ³n cancelada.');
				return;
			}

			try {
				// Limpiar Ã³rdenes
				AppState.orders = [];
				await API.save('orders', []);

				// Limpiar transacciones
				AppState.transactions = [];
				await API.save('transactions', []);

				// Limpiar cierres de caja
				AppState.cashClosures = [];
				await API.save('cash_closures', []);

				// Resetear estado de mesas
				AppState.tables.forEach(table => {
					table.status = 'available';
					table.currentOrder = null;
				});
				await API.save('tables', AppState.tables);

				alert('âœ… Datos de ventas eliminados correctamente.\n\nLa aplicaciÃ³n estÃ¡ lista para uso en producciÃ³n.');
				
				// Refrescar vistas
				renderDashboard();
				renderOrders();
				renderTransactions();
				updateSystemInfo();
				generateProfitabilityReport();
			} catch (error) {
				alert('âŒ Error al limpiar datos: ' + error.message);
				console.error(error);
			}
		}

		function updateSystemInfo() {
			document.getElementById('info-menu-items').textContent = AppState.menuItems.length;
			document.getElementById('info-tables').textContent = AppState.tables.length;
			document.getElementById('info-orders').textContent = AppState.orders.length;
			document.getElementById('info-waiters').textContent = AppState.waiters.length;
		}

		// FunciÃ³n para cerrar sesiÃ³n
		function logout() {
			if (confirm('Â¿Cerrar sesiÃ³n?')) {
				localStorage.removeItem('userSession');
				window.location.href = '/login.html';
			}
		}

		init();
	</script>
</body>
</html>